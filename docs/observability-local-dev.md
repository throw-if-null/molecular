# Local observability (Jaeger + OpenTelemetry Collector)

This repo includes a local dev stack for viewing OpenTelemetry traces in Jaeger.

It uses Podman Quadlets (systemd-managed containers), not compose.

Note: the Jaeger container uses Jaeger v2 (Jaeger v1 is EOL).

To keep local dev repeatable, container images are pinned in `quadlets/`.

## What are quadlets?

Quadlets are small `.container`/`.network` files that Podman reads via a systemd generator.
They turn into normal systemd units you control with `systemctl --user` and inspect with `journalctl`.

## Prereqs

- `podman`
- systemd user services (`systemctl --user ...`)
- Optional (recommended): keep user services running after logout:

```sh
loginctl enable-linger "$USER"
```

## Install the quadlets

The quadlet units live in `quadlets/`.

Copy them into the user quadlet search path:

```sh
mkdir -p "$HOME/.config/containers/systemd/molecular"
cp quadlets/* "$HOME/.config/containers/systemd/molecular/"
systemctl --user daemon-reload
```

Unit names (generated by quadlet):

- `molecular-observability.network` -> `molecular-observability-network.service`
- `molecular-jaeger.container` -> `molecular-jaeger.service`
- `molecular-otel-collector.container` -> `molecular-otel-collector.service`
- `molecular-tracegen.container` -> `molecular-tracegen.service` (one-shot)

## Start/stop

Start Jaeger + Collector:

```sh
systemctl --user start molecular-jaeger.service
systemctl --user start molecular-otel-collector.service
```

If you see an error like `short-name resolution enforced but cannot prompt without a TTY`, it means Podman refused to pull an unqualified image name under systemd.
These quadlets use fully-qualified image names (e.g. `docker.io/...`) to avoid that.

Stop:

```sh
systemctl --user stop molecular-otel-collector.service
systemctl --user stop molecular-jaeger.service
```

## Status + logs

```sh
systemctl --user status molecular-jaeger.service
systemctl --user status molecular-otel-collector.service

journalctl --user -u molecular-jaeger.service -f
journalctl --user -u molecular-otel-collector.service -f
```

## Jaeger UI

Open `http://127.0.0.1:16686`.

## Generate a test trace

Run the one-shot generator (emits 10 traces via OTLP/gRPC to the collector):

```sh
systemctl --user start molecular-tracegen.service
```

Then open Jaeger and search for service `molecular-tracegen`.

Optional: verify via the Jaeger API:

```sh
curl -fsS http://127.0.0.1:16686/api/services
```

If `molecular-tracegen` logs show `connection refused` to the collector, verify the collector is listening on `0.0.0.0:4317` inside the container.
The shipped collector config explicitly binds OTLP gRPC/HTTP to `0.0.0.0` so other containers on the network can reach it.

Tip: the upstream `otel/opentelemetry-collector` image is minimal and may not include a shell for `podman exec ... /bin/sh` debugging.
For network/port checks, use a tiny debug container on the same network instead:

```sh
podman run --rm --network molecular-observability docker.io/busybox:latest \
  sh -lc 'nc -zvw3 molecular-jaeger 4317 && nc -zvw3 molecular-otel-collector 4317'
```

If you previously ran a compose-based stack, you may need to remove old containers with conflicting names:

```sh
podman rm -f jaeger otel-collector 2>/dev/null || true
```

## Configure Silicon (local dev)

Point your OTLP exporter at the local Collector:

```sh
export OTEL_EXPORTER_OTLP_ENDPOINT=http://127.0.0.1:4318
export OTEL_EXPORTER_OTLP_PROTOCOL=http/protobuf
```

Ports:

- Collector OTLP gRPC: `127.0.0.1:4317`
- Collector OTLP HTTP: `127.0.0.1:4318`
- Jaeger UI: `127.0.0.1:16686`

## Uninstall

```sh
systemctl --user stop molecular-otel-collector.service molecular-jaeger.service || true
rm -rf "$HOME/.config/containers/systemd/molecular"
systemctl --user daemon-reload
```

If you change `molecular-observability.network` options, you may need to manually remove the existing network before restarting:

```sh
podman network rm molecular-observability
```
