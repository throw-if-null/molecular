{
  "name": "Foreman",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "run-foreman",
        "responseMode": "lastNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [-5888, 256],
      "id": "a49f9dab-a46e-4305-a9f5-9972f6e3444a",
      "name": "Start",
      "webhookId": "25673ee8-bf54-43e5-9912-6ae2db478f78"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "retry_count",
              "value": "0"
            },
            {
              "name": "max_retries",
              "value": "3"
            },
            {
              "name": "transient_retry_builder",
              "value": "0"
            },
            {
              "name": "transient_max_retries_builder",
              "value": "3"
            },
            {
              "name": "transient_retry_inspector",
              "value": "0"
            },
            {
              "name": "transient_max_retries_inspector",
              "value": "3"
            },
            {
              "name": "task_id",
              "value": "={{ $json.body.task_id }}"
            },
            {
              "name": "prompt",
              "value": "={{ $json.body.prompt }}"
            },
            {
              "name": "worktree_path",
              "value": "=.oc_worktrees/{{ $json.body.task_id }}"
            },
            {
              "name": "timeStamp",
              "value": "={{(()=>{\n  return DateTime.now().toFormat('yyyyLLdd.HHmm');\n})()}}"
            },
            {
              "name": "mode",
              "value": "={{ (() => {\n  const url = $json.webhookUrl || '';\n  if (url.endsWith('run-foreman')) return 'full';\n  if (url.endsWith('run-inspector')) return 'review';\n  return 'unknown';\n})() }}"
            },
            {
              "name": "builder_pass",
              "value": "1"
            },
            {
              "name": "inspector_pass",
              "value": "0"
            },
            {
              "name": "setup_done",
              "value": "0"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [-5200, 80],
      "id": "0056f2aa-d17a-4523-b4a2-d7721c7ee216",
      "name": "Initialize Variables"
    },
    {
      "parameters": {
        "command": "=REPO=\"${FOREMAN_REPO:-$(pwd)}\"\nWORKTREE=\"$REPO/{{ $json.worktree_path }}\"\n\nif [ -d \"$WORKTREE\" ] && git -C \"$WORKTREE\" rev-parse --is-inside-work-tree >/dev/null 2>&1; then\n  echo 'exists=true'\nelse\n  echo 'exists=false'\nfi"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [-4752, 128],
      "id": "15383908-7575-4537-8182-12d76b5a2268",
      "name": "Check Worktree Exists"
    },
    {
      "parameters": {
        "jsCode": "const stdout = String($input.first().json.stdout || '').trim();\nconst exists = stdout.includes('exists=true');\nreturn [{ worktree_exists: exists }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-4528, 128],
      "id": "0b434eed-0616-4c91-8a29-c8428dce6029",
      "name": "Parse Worktree Exists"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "id": "c6d8c9f0-0d2c-4d10-b962-4d4ccf8b4d10",
              "leftValue": "={{ $json.worktree_exists }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "isTrue"
              }
            },
            {
              "id": "d09a1627-33ab-4e21-8b43-ab2b9cdcca41",
              "leftValue": "={{ $json.worktree_exists }}",
              "rightValue": "true",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [-4304, 128],
      "id": "66e0fb66-bd56-4fad-b2cd-9f50e92d9147",
      "name": "Worktree Exists?"
    },
    {
      "parameters": {
        "command": "=REPO=\"${FOREMAN_REPO:-$(pwd)}\"\n\ngit -C \"$REPO\" worktree add -b feature/{{ $('Initialize Variables').item.json.task_id }} \"$REPO/{{ $('Initialize Variables').item.json.worktree_path }}\" main"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [-4112, 272],
      "id": "fd460acb-a98b-45a1-af56-e27455a4f73c",
      "name": "Setup Git Worktree"
    },
    {
      "parameters": {
        "command": "=REPO=\"${FOREMAN_REPO:-$(pwd)}\"\n\ncd \"$REPO/{{ $('Initialize Variables').item.json.worktree_path }}/components\" && \\\npnpm i"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [-3888, 112],
      "id": "3ee06c07-be10-45e5-8dc3-7758b95bb2f9",
      "name": "Setup Repository"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "setup_done",
              "value": "1"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [-3712, 112],
      "id": "5e372d5e-350f-4e9b-b49b-3d74c50131fd",
      "name": "Mark Setup Done"
    },
    {
      "parameters": {
        "resume": "webhook",
        "httpMethod": "POST",
        "options": {}
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [-3184, -672],
      "id": "10589852-074c-4b9d-b394-39f7f3598fd6",
      "name": "Wait for Builder",
      "webhookId": "7fae1480-f059-48d9-9a0d-864c586b17a0"
    },
    {
      "parameters": {
        "command": "=REPO=\"${FOREMAN_REPO:-$(pwd)}\"\n\ncd \"$REPO/{{ $('Initialize Variables').item.json.worktree_path }}\" && \\\n  python \"$REPO/.foreman/tools/check_builder_handoff.py\""
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [-2960, -672],
      "id": "a69fe01b-7786-4b39-88ca-9f529e00cfd8",
      "name": "Check Builder Handoff"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "f1b27a9b-50f1-4d8e-8ddd-1e15d91dfc71",
                    "leftValue": "={{ $json.status }}",
                    "rightValue": "valid",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "e2b0c6c4-8bbd-4b46-97e2-8f9a469a63f3",
                    "leftValue": "={{ $json.status }}",
                    "rightValue": "file_missing",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "1f9aa194-73e4-465d-b7c3-5d31f3d6e0ef",
                    "leftValue": "={{ $json.status }}",
                    "rightValue": "invalid_json",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [-2512, -688],
      "id": "317ee001-6331-4ab3-9622-3cb319b551ee",
      "name": "Builder Result Switch"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "0a3dd3eb-0c1c-4f0b-bfb8-59f0f2f0b8c0",
              "leftValue": "={{ $json.data.run.status }}",
              "rightValue": "ok",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [-2288, -816],
      "id": "b63efc1b-9774-47b4-8f07-5f474a858ebe",
      "name": "Is Builder Run OK"
    },
    {
      "parameters": {
        "jsCode": "const current = parseInt($('Initialize Variables').first().json.transient_retry_builder || '0', 10);\nreturn [{ transient_retry_builder: String(current + 1) }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-2288, -112],
      "id": "23bc7209-ddc4-4937-8188-d148349e6f21",
      "name": "Increment Builder Transient"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "3341c2d1-083c-4283-9db1-56aedb5bd956",
              "leftValue": "={{ $json.transient_retry_builder }}",
              "rightValue": "={{ $('Initialize Variables').first().json.transient_max_retries_builder }}",
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [-2064, -112],
      "id": "0a2ee538-52f9-41d5-964e-1371572aebba",
      "name": "Should Retry Builder Transient"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "transient_retry_builder",
              "value": "={{ $json.transient_retry_builder }}"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [-1776, 16],
      "id": "7641aff4-9bb5-419f-bd4d-4f187e4cb73d",
      "name": "Persist Builder Transient"
    },
    {
      "parameters": {
        "command": "=REPO=\"${FOREMAN_REPO:-$(pwd)}\"\nWORKTREE=\"$REPO/{{ $('Initialize Variables').item.json.worktree_path }}\"\n\ncd \"$WORKTREE\" && \\\ngit diff main...HEAD > inspector_diff.patch"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [-2064, -736],
      "id": "9893d0b8-a8c0-44af-afb4-2b2156443d25",
      "name": "Create the DIFF"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst fallback = $('Initialize Variables').first().json;\nconst raw = input.inspector_pass ?? fallback.inspector_pass ?? '0';\nconst current = parseInt(String(raw), 10);\nreturn [{ inspector_pass: String(Number.isFinite(current) ? current + 1 : 1) }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-1840, -736],
      "id": "ffc812ee-698d-4a03-ba4b-b090fe9bbf93",
      "name": "Increment Inspector Pass (Auto)"
    },
    {
      "parameters": {
        "command": "=# 1. Define paths\nREPO=\"${FOREMAN_REPO:-$(pwd)}\"\nRUNNER_SCRIPT=\"$REPO/.foreman/tools/agent_runner.py\"\nWORKTREE=\"$REPO/{{ $('Initialize Variables').item.json.worktree_path }}\"\nRESUME_URL=\"{{ $execution.resumeUrl }}\"\n\n# 2. Build a prompt file safely (no command substitution)\nPROMPT_FILE=\"$REPO/.foreman/.tmp/inspector_{{ $('Initialize Variables').item.json.body.task_id }}.prompt.md\"\nmkdir -p \"$(dirname \"$PROMPT_FILE\")\"\n\ncat \"$REPO/.foreman/inspector/templates/inspector_base_prompt.md\" > \"$PROMPT_FILE\"\ncat <<'EOF' >> \"$PROMPT_FILE\"\n\nThe task being reviewed is:\n{{ $('Initialize Variables').item.json.body.prompt }}\nEOF\n\n# 3. Execution: run Inspector via agent_runner.py using a prompt file\nnohup python3 \"$RUNNER_SCRIPT\" \\\n  --webhook \"$RESUME_URL\" \\\n  --cwd \"$WORKTREE\" \\\n  --agent inspector \\\n  --title \"INSPECTOR {{ $('Initialize Variables').item.json.body.task_id }} {{ $('Initialize Variables').item.json.timeStamp }} b{{ $('Initialize Variables').first().json.builder_pass }}-i{{ $('Initialize Variables').first().json.inspector_pass }}\" \\\n  --prompt-file \"$PROMPT_FILE\" \\\n  > /dev/null 2>&1 &"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [-1392, -736],
      "id": "dd689b3e-5828-46fb-ac6c-6658c76ebcfa",
      "name": "Run Inspector Agent",
      "notesInFlow": false,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "resume": "webhook",
        "httpMethod": "POST",
        "options": {}
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [-1168, -816],
      "id": "217af56e-a80f-4580-85ca-8ecc4821b75f",
      "name": "Wait fo Inspector",
      "webhookId": "19eb0f2f-c982-4e12-92f6-be4cdcb74ee9"
    },
    {
      "parameters": {
        "command": "=REPO=\"${FOREMAN_REPO:-$(pwd)}\"\n\ncd \"$REPO/{{ $('Initialize Variables').item.json.worktree_path }}\" && \\\n  python \"$REPO/.foreman/tools/check_inspector_handoff.py\""
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [-944, -816],
      "id": "ef6336ac-e39b-4ffc-b6be-b45b24166c94",
      "name": "Check Inspector Handoff"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "4f0b4c00-f2bd-4b54-b2c7-6c62e4f63c68",
                    "leftValue": "={{ $json.status }}",
                    "rightValue": "valid",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "41bcb2d2-ad2d-4d2b-856c-06248d2b0a70",
                    "leftValue": "={{ $json.status }}",
                    "rightValue": "file_missing",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 3
                },
                "conditions": [
                  {
                    "id": "8878bf1f-0b24-4cb1-8c4a-4560b0b1ee45",
                    "leftValue": "={{ $json.status }}",
                    "rightValue": "invalid_json",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              }
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.4,
      "position": [-496, -832],
      "id": "861eb3f8-28f7-46c8-89d9-c6e8d0c2ee20",
      "name": "Inspector Result Switch"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "96d2b1ab-4d15-48a6-abd6-854d5356cb94",
              "leftValue": "={{ $json.data.run.status }}",
              "rightValue": "ok",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [-272, -944],
      "id": "2f650a14-d80f-4c16-9dc6-287199ef9359",
      "name": "Is Inspector Run OK"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "id": "2df5974e-7c8d-4f10-a34a-a04ce3d0c2ff",
              "leftValue": "={{ $json.data.work.status }}",
              "rightValue": "approved",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [-48, -864],
      "id": "a91051f0-4be6-4ffa-9ce1-6a24474bcb2b",
      "name": "Is Inspector Approved"
    },
    {
      "parameters": {
        "jsCode": "const current = parseInt($('Initialize Variables').first().json.transient_retry_inspector || '0', 10);\nreturn [{ transient_retry_inspector: String(current + 1) }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-272, -544],
      "id": "85e78639-93f1-452f-9be1-1a61f28ebb45",
      "name": "Increment Inspector Transient"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "2c69b8f5-0c49-4ee1-8d9d-acde1b0092ef",
              "leftValue": "={{ $json.transient_retry_inspector }}",
              "rightValue": "={{ $('Initialize Variables').first().json.transient_max_retries_inspector }}",
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [-48, -544],
      "id": "d991417e-6a71-4c94-878f-291d8ab6f177",
      "name": "Should Retry Inspector Transient"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "transient_retry_inspector",
              "value": "={{ $json.transient_retry_inspector }}"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [176, -384],
      "id": "b943a770-d8e5-40da-9ad7-7efc9b8c1ab6",
      "name": "Persist Inspector Transient"
    },
    {
      "parameters": {
        "command": "=REPO=\"${FOREMAN_REPO:-$(pwd)}\"\n\npython \"$REPO/.foreman/tools/create_pr.py\" \\\n  --task-id \"{{ $('Initialize Variables').first().json.task_id }}\" \\\n  --title \"feat: {{ $('Initialize Variables').first().json.task_id }} implementation\" \\\n  --body \"{{ $('Initialize Variables').first().json.body.prompt }}\" \\\n  --worktree \"$REPO/{{ $('Initialize Variables').first().json.worktree_path }}\" \\\n  --branch \"feature/{{ $('Initialize Variables').first().json.task_id }}\""
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [1040, -1136],
      "id": "fc3c8533-2209-47ac-964b-c251080740fd",
      "name": "Create the PR"
    },
    {
      "parameters": {
        "command": "=REPO=\"${FOREMAN_REPO:-$(pwd)}\"\nTASK_ID=\"{{ $('Initialize Variables').first().json.task_id }}\"\n\nWHO=\"builder\"\nif [ \"{{ $json.data.work.status || '' }}\" != \"\" ]; then\n  WHO=\"inspector\"\nfi\n\nREPORT_DIR=\".foreman/failures/$WHO\"\nREPORT_FILE=\"$REPORT_DIR/${TASK_ID}_report.json\"\nmkdir -p \"$REPORT_DIR\"\n\nREASON=\"unknown\"\nif [ \"{{ $json.status }}\" != \"valid\" ]; then\n  REASON=\"result_invalid\"\nelif [ \"{{ $json.data.run.status }}\" != \"ok\" ]; then\n  REASON=\"run_failed\"\nelif [ \"{{ $json.data.work.status || '' }}\" != \"approved\" ]; then\n  REASON=\"changes_requested\"\nelse\n  REASON=\"unexpected\"\nfi\n\npython3 \"$REPO/.foreman/tools/write_foreman_failure_summary.py\" \\\n  --status \"{{ $json.status }}\" \\\n  --reason \"$REASON\" \\\n  --raw-json '{{ JSON.stringify($json) }}' \\\n  > \"$REPORT_FILE\""
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [576, -1440],
      "id": "e45ae152-dc0b-458b-868d-8dffc730f463",
      "name": "Log Rejection"
    },
    {
      "parameters": {
        "jsCode": "const raw = $input.first().json.stdout || '';\n\nlet parsed;\ntry {\n  parsed = JSON.parse(raw);\n} catch (e) {\n  parsed = null;\n}\n\nconst work = parsed?.data?.work || {};\nconst issues = Array.isArray(work.issues) ? work.issues : [];\nconst nextTasks = Array.isArray(work.next_tasks) ? work.next_tasks : [];\n\nconst issueText = issues\n  .map((i, idx) => {\n    const sev = i?.severity ? `[${i.severity}] ` : '';\n    const desc = i?.description || '';\n    const paths = Array.isArray(i?.paths) && i.paths.length ? `\\n  Paths: ${i.paths.join(', ')}` : '';\n    return `${idx + 1}. ${sev}${desc}${paths}`.trim();\n  })\n  .filter(Boolean)\n  .join('\\n\\n');\n\nconst nextText = nextTasks.map((t) => `- ${t}`).join('\\n');\n\nconst sections = [];\nif (issueText) sections.push(`ISSUES:\\n${issueText}`);\nif (nextText) sections.push(`NEXT TASKS:\\n${nextText}`);\n\nconst changeRequests = sections.join('\\n\\n');\nconst retry = parseInt($('Initialize Variables').first().json.retry_count || '0', 10);\nreturn [{ change_requests: changeRequests, retry_count: String(retry + 1) }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [176, -752],
      "id": "787dfe90-e894-4eea-9f9a-4643c6bd2f1f",
      "name": "Update Retry State"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "id": "c1c1c1c1-1111-2222-3333-444444444444",
              "leftValue": "={{ $json.retry_count }}",
              "rightValue": "={{ $('Initialize Variables').first().json.max_retries }}",
              "operator": {
                "type": "number",
                "operation": "lt"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [400, -752],
      "id": "8c14f976-8fc4-4388-acf0-9029c18a0840",
      "name": "Should Retry"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "change_requests",
              "value": "={{ $json.change_requests }}"
            },
            {
              "name": "retry_count",
              "value": "={{ $json.retry_count }}"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [624, -592],
      "id": "6f7453c6-aed3-4c74-8663-c2d654168bb6",
      "name": "Persist Retry Vars"
    },
    {
      "parameters": {
        "jsCode": "const input = $input.first().json;\nconst fallback = $('Initialize Variables').first().json;\nconst raw = input.builder_pass ?? fallback.builder_pass ?? '1';\nconst current = parseInt(String(raw), 10);\nreturn [{ builder_pass: String(Number.isFinite(current) ? current + 1 : 2) }];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [848, -592],
      "id": "56e10c68-b619-43d0-9c23-b4c84d815114",
      "name": "Increment Builder Pass"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "builder_pass",
              "value": "={{ $json.builder_pass }}"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [1072, -320],
      "id": "9cb06aca-45dc-4e04-8f99-197304b61038",
      "name": "Persist Builder Pass"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 3
          },
          "conditions": [
            {
              "id": "6a7f2f7c-4f14-4c55-92c4-9c2a7f6ba5ac",
              "leftValue": "={{ $json.mode }}",
              "rightValue": "full",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            },
            {
              "id": "a18e1430-6930-4a56-b8e4-8f519f9b8a1d",
              "leftValue": "={{ $('Initialize Variables').first().json.setup_done }}",
              "rightValue": "1",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [-4976, 80],
      "id": "90a8fbc0-b07b-4de9-8e45-d7455df4ec9e",
      "name": "Setup Gate"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "run-inspector",
        "responseMode": "lastNode",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [-5872, -64],
      "id": "9b661c67-544d-4c1e-b904-221acb1567e5",
      "name": "Review",
      "webhookId": "0d33a427-d5ca-4d31-8dda-d8a963a9db4e"
    },
    {
      "parameters": {
        "jsCode": "const text = $input.first().json.stdout || '';\n\nlet result;\ntry {\n  result = JSON.parse(text);\n} catch (e) {\n  throw new Error('Failed to parse handoff JSON: ' + e.message);\n}\n  // n8n expects an array of items\nreturn [result];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-720, -816],
      "id": "db6df07a-4d44-4dab-9c3c-033010bed17f",
      "name": "Process Inspector response"
    },
    {
      "parameters": {
        "jsCode": "const text = $input.first().json.stdout || '';\n\nlet result;\ntry {\n  result = JSON.parse(text);\n} catch (e) {\n  throw new Error('Failed to parse handoff JSON: ' + e.message);\n}\n  // n8n expects an array of items\nreturn [result];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-2736, -672],
      "id": "ea4ae00e-fe66-4c19-8b1b-20a1fdcd99d5",
      "name": "Process Builder response"
    },
    {
      "parameters": {
        "command": "=# 1. Define paths\nREPO=\"${FOREMAN_REPO:-$(pwd)}\"\nRUNNER_SCRIPT=\"$REPO/.foreman/tools/agent_runner.py\"\nWORKTREE=\"$REPO/{{ $('Initialize Variables').item.json.worktree_path }}\"\nRESUME_URL=\"{{ $execution.resumeUrl }}\"\n\n# 2. Build a prompt file safely (no command substitution)\nPROMPT_FILE=\"$REPO/.foreman/.tmp/builder_{{ $('Initialize Variables').item.json.body.task_id }}.prompt.md\"\nmkdir -p \"$(dirname \"$PROMPT_FILE\")\"\n\nTEMPLATE=\"builder_base_prompt_initial.md\"\n\ncat \"$REPO/.foreman/builder/templates/$TEMPLATE\" > \"$PROMPT_FILE\"\ncat <<'EOF' >> \"$PROMPT_FILE\"\n\nThe user task is:\n{{ $('Initialize Variables').item.json.body.prompt }}\n\nEOF\n\n# 3. Execution: run Builder via agent_runner.py using a prompt file\nnohup python3 \"$RUNNER_SCRIPT\" \\\n  --webhook \"$RESUME_URL\" \\\n  --cwd \"$WORKTREE\" \\\n  --agent builder \\\n  --title \"BUILDER {{ $('Initialize Variables').item.json.body.task_id }} {{ $('Initialize Variables').item.json.timeStamp }} b{{ $('Initialize Variables').first().json.builder_pass }}-i{{ $('Initialize Variables').first().json.inspector_pass }}\" \\\n  --prompt-file \"$PROMPT_FILE\" \\\n  > /dev/null 2>&1 &"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [-3472, -672],
      "id": "de26fa42-8d1c-41f9-b979-a93de1a3f1bb",
      "name": "Run Builder Agent (Initial)",
      "alwaysOutputData": false,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "command": "=# 1. Define paths\nREPO=\"${FOREMAN_REPO:-$(pwd)}\"\nRUNNER_SCRIPT=\"$REPO/.foreman/tools/agent_runner.py\"\nWORKTREE=\"$REPO/{{ $('Initialize Variables').item.json.worktree_path }}\"\nRESUME_URL=\"{{ $execution.resumeUrl }}\"\n\n# 2. Build a prompt file safely (no command substitution)\nPROMPT_FILE=\"$REPO/.foreman/.tmp/builder_{{ $('Initialize Variables').item.json.body.task_id }}.prompt.md\"\nmkdir -p \"$(dirname \"$PROMPT_FILE\")\"\n\nTEMPLATE=\"builder_base_prompt_revision.md\"\n\ncat \"$REPO/.foreman/builder/templates/$TEMPLATE\" > \"$PROMPT_FILE\"\ncat <<'EOF' >> \"$PROMPT_FILE\"\n\nThe user task is:\n{{ $('Initialize Variables').item.json.body.prompt }}\nThe inspector requested changes:\n{{ $('Check Inspector Handoff').item.json.change_requests }}\n\nEOF\n\n# 3. Execution: run Builder via agent_runner.py using a prompt file\nnohup python3 \"$RUNNER_SCRIPT\" \\\n  --webhook \"$RESUME_URL\" \\\n  --cwd \"$WORKTREE\" \\\n  --agent builder \\\n  --title \"BUILDER {{ $('Initialize Variables').item.json.body.task_id }} {{ $('Initialize Variables').item.json.timeStamp }} b{{ $('Persist Builder Pass').first().json.builder_pass }}-i{{ $('Persist Inspector Pass').first().json.inspector_pass }}\" \\\n  --prompt-file \"$PROMPT_FILE\" \\\n  > /dev/null 2>&1 &"
      },
      "type": "n8n-nodes-base.executeCommand",
      "typeVersion": 1,
      "position": [-3424, -368],
      "id": "7fe708e9-6da4-4107-b1f1-e1606166ff54",
      "name": "Run Builder Agent (Revision)",
      "alwaysOutputData": false,
      "onError": "continueErrorOutput"
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "inspector_pass",
              "value": "={{ $json.inspector_pass }}"
            }
          ]
        },
        "options": {
          "dotNotation": true
        }
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [-1616, -736],
      "id": "e90489ed-dbd7-41f2-874f-c2b3ada5bccf",
      "name": "Persist Inspector Pass"
    }
  ],
  "pinData": {},
  "connections": {
    "Should Retry2": {
      "main": [
        [
          {
            "node": "Persist Retry Vars2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Rejection2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Retry1": {
      "main": [
        [],
        [
          {
            "node": "Log Rejection1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Persist Retry Vars1": {
      "main": [
        [
          {
            "node": "Increment Builder Pass1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Persist Retry Vars2": {
      "main": [
        [
          {
            "node": "Increment Builder Pass2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Increment Builder Pass1": {
      "main": [
        [
          {
            "node": "Persist Builder Pass1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Increment Builder Pass2": {
      "main": [
        [
          {
            "node": "Persist Builder Pass2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Persist Builder Pass1": {
      "main": [
        [
          {
            "node": "Run Builder Agent2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Persist Builder Pass2": {
      "main": [
        [
          {
            "node": "Run Builder Agent3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setup Gate1": {
      "main": [
        [
          {
            "node": "Run Builder Agent2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Worktree Exists1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setup Gate2": {
      "main": [
        [
          {
            "node": "Run Builder Agent3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Worktree Exists2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Increment Inspector Pass (Manual)1": {
      "main": [
        [
          {
            "node": "Persist Inspector Pass (Manual)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Increment Inspector Pass (Manual)2": {
      "main": [
        [
          {
            "node": "Persist Inspector Pass (Manual)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Persist Inspector Pass (Manual)1": {
      "main": [
        [
          {
            "node": "Initialize Variables1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Persist Inspector Pass (Manual)2": {
      "main": [
        [
          {
            "node": "Initialize Variables2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Review1": {
      "main": [
        [
          {
            "node": "Increment Inspector Pass (Manual)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Review2": {
      "main": [
        [
          {
            "node": "Increment Inspector Pass (Manual)2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Start": {
      "main": [
        [
          {
            "node": "Initialize Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Initialize Variables": {
      "main": [
        [
          {
            "node": "Setup Gate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setup Gate": {
      "main": [
        [
          {
            "node": "Run Builder Agent (Initial)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Check Worktree Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Worktree Exists": {
      "main": [
        [
          {
            "node": "Parse Worktree Exists",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Worktree Exists": {
      "main": [
        [
          {
            "node": "Worktree Exists?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Worktree Exists?": {
      "main": [
        [
          {
            "node": "Setup Repository",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Setup Git Worktree",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setup Git Worktree": {
      "main": [
        [
          {
            "node": "Setup Repository",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Setup Repository": {
      "main": [
        [
          {
            "node": "Mark Setup Done",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mark Setup Done": {
      "main": [
        [
          {
            "node": "Run Builder Agent (Initial)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait for Builder": {
      "main": [
        [
          {
            "node": "Check Builder Handoff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Builder Handoff": {
      "main": [
        [
          {
            "node": "Process Builder response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Builder Result Switch": {
      "main": [
        [
          {
            "node": "Is Builder Run OK",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Increment Builder Transient",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Increment Builder Transient",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Builder Run OK": {
      "main": [
        [
          {
            "node": "Create the DIFF",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Rejection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Increment Builder Transient": {
      "main": [
        [
          {
            "node": "Should Retry Builder Transient",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Retry Builder Transient": {
      "main": [
        [
          {
            "node": "Persist Builder Transient",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Rejection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Persist Builder Transient": {
      "main": [
        [
          {
            "node": "Run Builder Agent (Revision)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create the DIFF": {
      "main": [
        [
          {
            "node": "Increment Inspector Pass (Auto)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Increment Inspector Pass (Auto)": {
      "main": [
        [
          {
            "node": "Persist Inspector Pass",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Run Inspector Agent": {
      "main": [
        [
          {
            "node": "Wait fo Inspector",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait fo Inspector",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait fo Inspector": {
      "main": [
        [
          {
            "node": "Check Inspector Handoff",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Inspector Handoff": {
      "main": [
        [
          {
            "node": "Process Inspector response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Inspector Result Switch": {
      "main": [
        [
          {
            "node": "Is Inspector Run OK",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Increment Inspector Transient",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Increment Inspector Transient",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Inspector Run OK": {
      "main": [
        [
          {
            "node": "Is Inspector Approved",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Rejection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Is Inspector Approved": {
      "main": [
        [
          {
            "node": "Create the PR",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Update Retry State",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Increment Inspector Transient": {
      "main": [
        [
          {
            "node": "Should Retry Inspector Transient",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Retry Inspector Transient": {
      "main": [
        [
          {
            "node": "Persist Inspector Transient",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Rejection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Persist Inspector Transient": {
      "main": [
        [
          {
            "node": "Run Inspector Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Update Retry State": {
      "main": [
        [
          {
            "node": "Should Retry",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Should Retry": {
      "main": [
        [
          {
            "node": "Persist Retry Vars",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Log Rejection",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Persist Retry Vars": {
      "main": [
        [
          {
            "node": "Increment Builder Pass",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Increment Builder Pass": {
      "main": [
        [
          {
            "node": "Persist Builder Pass",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Persist Builder Pass": {
      "main": [
        [
          {
            "node": "Run Builder Agent (Revision)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Review": {
      "main": [
        [
          {
            "node": "Initialize Variables",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Inspector response": {
      "main": [
        [
          {
            "node": "Inspector Result Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Builder response": {
      "main": [
        [
          {
            "node": "Builder Result Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Run Builder Agent (Initial)": {
      "main": [
        [
          {
            "node": "Wait for Builder",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait for Builder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Run Builder Agent (Revision)": {
      "main": [
        [
          {
            "node": "Wait for Builder",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Wait for Builder",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Persist Inspector Pass": {
      "main": [
        [
          {
            "node": "Run Inspector Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "66d4170b-1be1-4dbd-8a51-6c06399d3951",
  "meta": {
    "instanceId": "b11168fb8d2189bb65765ba38337a8f759c5093954de979172c9be19e0a9355a"
  },
  "id": "zJD1NAj5NGGDGbPmWurIz",
  "tags": []
}
